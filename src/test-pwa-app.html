<link rel="import" href="../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="views/image-list-view.html">

<dom-module id="test-pwa-app">
  <template>
    <style>
      :host {
        @apply --shadow-elevation-2dp;

        background: white;
        display: block;
        height: 100%;
        margin: auto;
        max-width: 960px;
        overflow: auto;
      }

      @media (min-width: 1025px) {
        :host::-webkit-scrollbar {
          background: transparent;
          width: 0.75em;
        }
        :host::-webkit-scrollbar-thumb {
          background: rgba(85, 85, 85, 0.25);
        }
        :host::-webkit-scrollbar-track {
        }
      }

      h1 {
        @apply --paper-font-display2;

        line-height: 1em;
        margin: 0;
        padding: 1em;
        text-align: center;
      }
      paper-toast {
        font-size: 1em;
      }
      paper-toast > paper-button {
        color: #eeff41;
      }
    </style>

    <h1>Some pics that I like</h1>

    <image-list-view></image-list-view>

    <paper-toast id="toast">
      <paper-button id="positiveButton" on-tap="_onToastPositiveButtonTapped"></paper-button>
    </paper-toast>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TestPwaApp extends Polymer.Element {
      static get is() {
        return 'test-pwa-app';
      }

      _onToastPositiveButtonTapped() {
        window.location.reload(true);
      }

      connectedCallback() {
        super.connectedCallback();
        console.log('connectedCallback()');

        this.addEventListener('tap', this._onItemTapped);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        console.log('disconnectedCallback()');

        this.removeEventListener('tap', this._onItemTapped);
      }

      _onItemTapped(e) {
        const origin = e.path[2];

        if (origin.nodeName != 'IMAGE-LIST-ITEM') return;

        console.log(origin);
      }

      ready() {
        super.ready();

        if (navigator.serviceWorker)
          this.registerServiceWorker();
      }

      registerServiceWorker() {
        navigator.serviceWorker.register('sw.js').then(reg => {
          let supportsPassiveListener = false;
          try {
            const opts = Object.defineProperty({}, 'passive', {
              get: function() {
                supportsPassiveListener = true;
              }
            });
            window.addEventListener('test', null, opts);
          } catch (e) {}

          reg.addEventListener('updatefound', () => {
            const activeSW = reg.active;
            const installingSW = reg.installing;
            let toastText;
            let toastButtonText;

            // If first install
            if (!activeSW) {
              toastButtonText = 'Reload to finish';
              toastText = 'Installation is almost complete';
            }
            // Else (if not first install)
            else {
              toastButtonText = 'Reload to update';
              toastText = 'New version available';
            }

            installingSW.addEventListener('statechange', () => {
              this.$.positiveButton.textContent = toastButtonText;
              this.$.toast.text = toastText;

              if (installingSW.state == 'activated') {
                this.$.toast.show({
                  duration: Infinity
                });
              }
            }, supportsPassiveListener ? {passive: true} : false);
          }, supportsPassiveListener ? {passive: true} : false);
        });
      }
    }

    window.customElements.define(TestPwaApp.is, TestPwaApp);
  </script>
</dom-module>
