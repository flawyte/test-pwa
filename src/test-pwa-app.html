<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="fragments/main-fragment.html">
<link rel="import" href="fragments/splash-fragment.html">

<dom-module id="test-pwa-app">
  <template>
    <style>
      :host {
        background: #eeeeee;
        display: block;
        height: 100%;
      }

      paper-toast {
        font-size: 1em;
      }
      paper-toast paper-button {
        color: #eeff41;
      }

      #frame {
        height: 100%;
        width: 100%;
      }
      #frame > * {
        height: 100%;
        position: absolute;
        width: 100%;
      }
    </style>

    <div id="frame">
      <div>
        <splash-fragment id="splashFragment"></splash-fragment>
      </div>
      <div>
        <main-fragment id="mainFragment"></main-fragment>
      </div>
    </div>

    <paper-toast id="toast">
      <paper-button id="positiveButton" on-tap="_onToastPositiveButtonTapped"></paper-button>
    </paper-toast>
  </template>

  <script>
    class TestPwaApp extends Polymer.Element {
      static get is() {
        return 'test-pwa-app';
      }

      constructor() {
        super();
        this.fragments = [];
        this.visibleFragments = [];
      }

      _onToastPositiveButtonTapped() {
        window.location.reload(true);
      }

      initFragments() {
        this.fragments = [
          this.$.mainFragment,
          this.$.splashFragment
        ];

        this.fragments.forEach(item => {
          item.frame = this;
          item.style.display = 'none';
        });
      }

      ready() {
        super.ready();

        if (navigator.serviceWorker)
          this.registerServiceWorker();

        this.initFragments();
        this.setVisibleFragment(this.$.splashFragment);
      }

      registerServiceWorker() {
        navigator.serviceWorker.register('sw.js').then(reg => {
          let supportsPassiveListener = false;
          try {
            const opts = Object.defineProperty({}, 'passive', {
              get: function() {
                supportsPassiveListener = true;
              }
            });
            window.addEventListener('test', null, opts);
          } catch (e) {}

          reg.addEventListener('updatefound', () => {
            const activeSW = reg.active;
            const installingSW = reg.installing;
            let toastText;
            let toastButtonText;

            // If first install
            if (!activeSW) {
              toastButtonText = 'Reload to finish';
              toastText = 'Installation is almost complete';
            }
            // Else (if not first install)
            else {
              toastButtonText = 'Reload to update';
              toastText = 'New version available';
            }

            installingSW.addEventListener('statechange', () => {
              this.$.positiveButton.textContent = toastButtonText;
              this.$.toast.text = toastText;

              if (installingSW.state == 'activated') {
                this.$.toast.show({
                  duration: Infinity
                });
              }
            }, supportsPassiveListener ? {passive: true} : false);
          }, supportsPassiveListener ? {passive: true} : false);
        });
      }

      setVisibleFragment(fragment) {
        if (this.visibleFragments.indexOf(fragment) !== -1) return;

        this.visibleFragments.forEach(item => {
          item.style.display = 'none';
          (typeof item.onInvisible === 'function') && item.onInvisible();
        });

        fragment.style.display = '';
        (typeof fragment.onVisible === 'function') && fragment.onVisible();
        this.visibleFragments = [fragment];
      }

      setVisibleFragmentByTag(tag) {
        this.setVisibleFragment(this.shadowRoot.querySelector(tag));
      }
    }

    window.customElements.define(TestPwaApp.is, TestPwaApp);

    window.addEventListener('beforeinstallprompt', e => {
      if (localStorage.getItem('showed-install-banner')) {
        e.preventDefault();
        return;
      }

      e.userChoice.then(choice => {
        localStorage.setItem('showed-install-banner', true);
      });
    });
  </script>
</dom-module>
